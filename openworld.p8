pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
--init
player={x=24,y=24,dx=0,dy=0,sprite=1,friction=0.8,maxspeed=1.5}
mapoffsetx=0
mapoffsety=0
dialog=""
dialogtimer=0
swordcollected=false
npctalked=false
function _init()
end

-->8
--update
function _update()
  --input
  if btn(⬆️) then player.dy-=0.2 end
  if btn(⬇️) then player.dy+=0.2 end
  if btn(⬅️) then player.dx-=0.2 end
  if btn(➡️) then player.dx+=0.2 end

  --friction
  player.dx*=player.friction
  player.dy*=player.friction

  --clamp to max speed
  player.dx=max(-player.maxspeed,min(player.maxspeed,player.dx))
  player.dy=max(-player.maxspeed,min(player.maxspeed,player.dy))

  --check collision and apply movement
  local newx=player.x+player.dx
  local newy=player.y+player.dy
  
  --check horizontal collision
  if not isblocked(newx,player.y) then
    player.x=newx
  else
    player.dx=0
  end
  
  --check vertical collision
  if not isblocked(player.x,newy) then
    player.y=newy
  else
    player.dy=0
  end

  --check for teleport trigger at tile 9,12
  local playertilex=player.x\8
  local playertiley=player.y\8
  if playertilex==9 and playertiley==12 then
    player.x=118*8
    player.y=9*8
    player.dx=0
    player.dy=0
    mapoffsetx=112
    mapoffsety=0
  end
  
  --check for teleport trigger at tile 118,10
  if playertilex==118 and playertiley==10 then
    player.x=9*8
    player.y=13*8
    player.dx=0
    player.dy=0
    mapoffsetx=0
    mapoffsety=0
  end
  
  --check for dialog trigger (sprite 005)
  local neartile5=false
  for px=player.x-4,player.x+11 do
    for py=player.y-4,player.y+11 do
      if mget(px\8,py\8)==5 then
        neartile5=true
      end
    end
  end
  
  if neartile5 and dialog=="" and dialogtimer==0 then
    dialog="Please find my wand. Ive missplaced it."
    npctalked=true
  elseif not neartile5 and npctalked and dialogtimer==0 then
    dialog=""
    npctalked=false
  end
  
  --check for sword pickup (sprite 048)
  if not swordcollected then
    for px=player.x-4,player.x+11 do
      for py=player.y-4,player.y+11 do
        if mget(px\8,py\8)==48 then
          swordcollected=true
          mset(px\8,py\8,16)
          dialog="You found a basic sword!"
          dialogtimer=300
        end
      end
    end
  end
  
  --update dialog timer
  if dialogtimer>0 then
    dialogtimer-=1
    if dialogtimer==0 then
      dialog=""
    end
  end

  --set sprite based on direction
  if abs(player.dx)>abs(player.dy) then
    if player.dx>0 then player.sprite=4 else player.sprite=3 end
  elseif abs(player.dy)>0.1 then
    if player.dy<0 then player.sprite=2 else player.sprite=1 end
  end
end

function isblocked(x,y)
  --check all 4 corners of player sprite
  local tiles={
    mget((x)\8,(y)\8),
    mget((x+7)\8,(y)\8),
    mget((x)\8,(y+7)\8),
    mget((x+7)\8,(y+7)\8)
  }
  for t in all(tiles) do
    if fget(t,0) then return true end
  end
  return false
end

function showdialog(text)
  if text=="" then return end
  --draw dialog box at bottom of screen
  rectfill(0,104,127,127,0)
  rect(0,104,127,127,6)
  print(text,4,108,7)
end

-->8
--draw
function _draw()
  cls()
  map(mapoffsetx,mapoffsety,0,0,16,16)
  spr(player.sprite,player.x-mapoffsetx*8,player.y-mapoffsety*8)
  showdialog(dialog)
end
__gfx__
00000000000000000000000000000000000000005555555500000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000001111000011110000111100001111005522225500000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700011111100111111001111110011111105222222500000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000010110100111111000101110011101005252252500000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000011111100111111001111110011111105222222500000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700011111100111111001111110011111105222222500000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000011111100111111001111110011111105222222500000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000111111111111111111111111111111112222222200000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333333355565555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333b33333355665555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333333b333b33333366666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333333b3333333b3355555655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333333333b33333333333b3355555665000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
333333333b333333333b333366666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3333333333333333333b333355565555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333333333333333333355665555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44044044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44044044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44000044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44044044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44044000555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44044044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44044044555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33373333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33373333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33373333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33373333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33444333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33343333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33333333000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000010000000000000000000000000001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1313131313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101010101010121010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101010101010101010101030101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101011101010101010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101010101010101010101110101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020202020202020000000000000
1310101010101010101210101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020212105212120000000000000
1310121010101010101010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020212121212120000000000000
1310101010101010101010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020212121212120000000000000
1310101011101010101010101011101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020212121212120000000000000
1310101010101010101010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020202021202020000000000000
1310101010101010102010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1311101010101010202020101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101010101010201020101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101010101110101010101010101300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1310101010101010101010101010121300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1313131313131313131313131313131300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
